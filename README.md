# RL Swarm: Руководство на русском

RL Swarm — это открытая система для распределённого обучения с подкреплением (RL) через интернет. Запуск узла Swarm позволяет тренировать вашу модель против коллективного интеллекта роя. Каждый рой выполняет RL-рассуждения как группа, используя систему обмена данными (Hivemind) для совместного улучшения моделей. Вы также можете подключить узел к тестовой сети Gensyn, чтобы получить ончейн-идентификатор для отслеживания прогресса.

RL Swarm полностью открыта и не требует разрешений. Вы можете запустить её на обычном ноутбуке или на мощном GPU в облаке. Также можно экспериментировать с разными моделями, чтобы найти лучшую.

## Требования

Убедитесь, что ваше устройство соответствует требованиям:

- **Процессор**: arm64 или x86 с минимум 16 ГБ оперативной памяти (учтите, что запуск других приложений во время обучения может вызвать сбой).
  
ИЛИ

- **CUDA-устройства** (официально поддерживаемые):
  - RTX 3090
  - RTX 4070
  - RTX 4090
  - A100
  - H100

И

- **Python**: версия >= 3.10 (на Mac, возможно, потребуется обновление).

## ⚠️ Важно прочитать перед началом ⚠️

Это **экспериментальное** ПО, предоставляемое "как есть" для пользователей, интересующихся ранней версией протокола Gensyn для тренировки моделей.

Если вам важна ончейн-регистрация, обязательно изучите раздел [Управление идентичностью](#управление-идентичностью).

При возникновении проблем сначала проверьте раздел [Устранение неисправностей](#устранение-неисправностей). Если решения нет, проверьте открытые или закрытые [Issues](../../issues) на GitHub. Если проблема не описана, создайте новый Issue, указав: 1) все логи, 2) информацию об устройстве (например, GPU), 3) данные об операционной системе.

## Инструкции

### Установка и запуск узла

1. Обновите систему и установите необходимые пакеты:
   ```sh
   apt update && apt install -y sudo
   sudo apt update && sudo apt upgrade -y
   sudo apt install -y curl wget git build-essential python3 python3-pip python3-venv screen
   ```

2. Установите Node.js и Yarn:
   ```sh
   curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
   sudo apt install -y nodejs
   yarn --version || npm install -g yarn
   ```

3. Установите Docker:
   ```sh
   sudo apt install -y docker.io docker-compose
   sudo systemctl enable docker --now
   ```

4. Скачайте и настройте ноду:
   ```sh
   git clone https://github.com/Zdonuk/Gensyn_testnet.git && cd GensynFix && chmod +x run_rl_swarm.sh
   ```

5. Запустите ноду в screen:
   ```sh
   screen -S gensyn
   ./run_rl_swarm.sh
   ```

6. Откройте новую вкладку терминала (не закрывая старую) и настройте проброс порта:
   ```sh
   ssh -o StrictHostKeyChecking=no -R 80:localhost:3000 serveo.net
   ```

### Участие в тестовой сети

На вопрос о тестовой сети отвечайте `Y` (или просто нажмите Enter). Ответ `N` предусмотрен, но этот режим не поддерживается.

### Авторизация

1. Откроется окно браузера (если вы используете виртуальную машину, вручную перейдите по адресу `http://localhost:3000/`).
2. Нажмите "Login".
3. Авторизуйтесь удобным способом (например, через Google).

### Hugging Face

Для связки с аккаунтом Hugging Face используйте ваш HF-токен. Подробности: [Hugging Face Security Tokens](https://huggingface.co/docs/hub/en/security-tokens).

### Начальная регистрация и обучение

После авторизации ваше устройство начнёт обучение в гипермасштабной системе. Вы можете увидеть регистрацию и голосование вашего узла в блокчейне по адресу: [Gensyn Testnet Explorer](https://gensyn-testnet.explorer.alchemy.com/address/0x2fC68a233EF9E9509f034DD551FF90A79a0B8F82?tab=logs).

## Управление идентичностью

### Введение

Ончейн-идентичность создаётся через интерфейс авторизации Alchemy. Вам нужно указать email или войти через поддерживаемый способ (например, Google). Это создаёт EOA-ключ (хранится в Alchemy) и локальные сессионные ключи (`userApiKey`). Эти ключи не являются EOA-ключами.

При настройке создаётся файл `swarm.pem`, который определяет идентичность узла. Он регистрируется в блокчейне через EOA-кошелёк Alchemy с использованием локальных API-ключей. Email и `swarm.pem` связаны навсегда — потеря одного из них делает связку неработоспособной.

Для нескольких узлов используйте разные email и `swarm.pem` для каждого. Копирование `swarm.pem`, `userApiKey`, `userData.json` или email между узлами приведёт к тому, что прогресс не будет отображаться в блокчейне, хотя узел будет работать и обучаться.

**Важно**: если вы используете форк репозитория или сторонний сервис (например, "развёртывание в один клик"), процесс управления идентичностью не гарантируется.

### Что это значит

**Работает** (прогресс будет отображаться в блокчейне):
- Первый запуск узла с новым email и новым `swarm.pem`.
- Повторный запуск с тем же `swarm.pem` и тем же email (может быть ошибка в логах, но транзакции будут подписываться).

**Не работает** (прогресс не будет в блокчейне):
- Потеря `swarm.pem` и попытка создать новый с уже использованным email.
- Использование `swarm.pem` с другим email, отличным от исходного.

**Рекомендации**:
- **Потеряли `swarm.pem`, но есть email**: начните с нуля с новым email (используйте Gmail с `+`, например, `example+1@gmail.com`).
- **Сохранили `swarm.pem` и email**: используйте их для повторного запуска одного узла (но не нескольких).
- **Хотите запустить несколько узлов**: настройте каждый с новым email и новым `swarm.pem`.

## Устранение неисправностей

- **Узел пропустил раунд**: Это нормально, если ваше устройство не успевает за скоростью роя. Например, если вы начали на 100-м раунде, а рой уже на 102-м, ваш узел пропустит 101-й и перейдёт к 102-му.
  
- **Модель не обучается?**
  - На слабых устройствах (например, MacBook) обучение может быть медленным. Проверьте через 20 минут.

- **Проблемы с повторной авторизацией?**
  - Нажмите "Logout" перед выходом из предыдущей сессии.
  - Удалите `swarm.pem` из корневой директории: `sudo rm swarm.pem`.

- **Проблемы с экраном авторизации?**
  - Обновите пакет `viem`:
    - В `modal-login/package.json` укажите: `"viem": "2.25.0"`.
    - Выполните: `cd /root/rl-swarm/modal-login/ && yarn upgrade && yarn add next@latest && yarn add viem@latest`.

- **Много предупреждений?**
  - Это нормально, часто из-за пакетных менеджеров. Игнорируйте предупреждение о Protobuf:
    ```
    WARNING: The candidate selected for download or install is a yanked version: 'protobuf' candidate...
    ```

- **Проблемы на VM/VPS?**
  - **Как открыть экран авторизации на VM?** Используйте проброс порта: `ssh -L 3000:localhost:3000`. Например: `gcloud compute ssh --zone "us-central1-a" [your-vm] --project [your-project] -- -L 3000:localhost:3000`. Некоторые VPS могут не поддерживать RL Swarm. Проверьте актуальную информацию в [Discord Gensyn](https://discord.gg/zAJbCTk9).
  - **Разрывы соединения**: При разрыве туннеля могут быть ошибки OOM. Прервите скрипт (`Ctrl+C`) и перезапустите.

- **Проблемы с установкой?**
  - Попробуйте: `npm install -g node@latest`.

- **Ошибки OOM на MacBook?**
  - Попробуйте: `export PYTORCH_MPS_HIGH_WATERMARK_RATIO=0.0`.

- **Работа на Windows?**
  - Установите WSL и Linux: [инструкция](https://learn.microsoft.com/en-us/windows/wsl/install). Требуется отладка.

- **Перенос узла с сохранением имени/идентификатора?**
  - Сохраните `swarm.pem` и перенесите его на новое устройство.

- **Несколько GPU на одном устройстве?**
  - Изолируйте GPU, установите репозиторий для каждого, настройте разные порты.

- **Раунд/стадия отстаёт?**
  - Это нормально из-за разной скорости устройств. Узел перейдёт к текущему раунду после завершения текущего.

- **Использование другой модели?**
  - Измените `./hivemind_exp/configs/<directory_relevant_to_your_device>/grpo-qwen-2.5-0.5b-deepseek-r1.yaml`, указав нужную модель. Поддерживаются модели, совместимые с `AutoModelForCausalLM` от Hugging Face, но протестированы только Qwen 2.5.

- **RuntimeError на CPU, обучение зависло?**
  - Убедитесь, что обучение действительно остановилось (подождите дольше одного цикла).
  - Попробуйте:
    - `export PYTORCH_MPS_HIGH_WATERMARK_RATIO=0.0 && ./run_rl_swarm.sh`.
    - В конфиге добавьте: `max_grad_norm=0.5`.
    - Используйте float32 вместо bfloat16 в конфиге.

- **Оптимизация RL Swarm?**
  - Откройте `hivemind_exp/configs/gpu/grpo-qwen-2.5-0.5b-deepseek-r1.yaml` и настройте параметры, например, `vllm_gpu_memory_utilization`. Оптимальные значения зависят от устройства.

## Swarm UI

Для запуска интерфейса:
```sh
docker-compose up --build
```
Откройте в браузере: `0.0.0.0:8080`.

Подробности: [web/README](./web/README.md).
